import { Severity, LayerRisk, Priority, ComplianceTag } from './mockData';

export interface VulnTimelineEvent {
  type: 'detected' | 'assigned' | 'status_change' | 'note' | 'patch';
  title: string;
  description: string;
  timestamp: string;
  user?: string;
}

export interface VulnNote {
  content: string;
  timestamp: string;
  author: string;
}

export interface VulnAffectedAsset {
  id: number;
  hostname: string;
  ip: string;
  type: string;
  os: string;
  layer: LayerRisk;
  patchStatus: 'Pendente' | 'Agendado' | 'Em progresso' | 'Aplicado';
  lastDetected: string;
}

export interface VulnReference {
  type: string;
  title: string;
  url: string;
}

export interface MitreMapping {
  id: string;
  name: string;
  tactic: string;
  subtechniques: string[];
}

export interface VulnerabilityDetail {
  qid: number;
  title: string;
  severity: Severity;
  layerRisk: LayerRisk;
  priority: Priority;
  status: 'open' | 'in_progress' | 'remediated' | 'accepted';
  description: string;
  vendor: string;
  product: string;
  affectedVersions: string;
  portProtocol: string;
  detectedDate: string;
  publishedDate: string;
  cvss: number;
  cvssVector: string;
  cveIds: string[];
  exploitability: string;
  publicExploit: boolean;
  cisaKev: boolean;
  mitreMapping: MitreMapping[];
  compliance: ComplianceTag[];
  assetCriticality: string;
  businessImpact: string;
  remediationSteps: string[];
  workarounds: string[];
  references: VulnReference[];
  affectedAssets: VulnAffectedAsset[];
  timeline: VulnTimelineEvent[];
  notes: VulnNote[];
  eol: boolean;
  agingDays: number;
  agingBucket: string;
  asset: string;
  assetType: string;
}

export const vulnerabilityDetails: Record<number, VulnerabilityDetail> = {
  376562: {
    qid: 376562,
    title: 'FortiOS Out-of-Bound Write Vulnerability',
    severity: 'critical',
    layerRisk: 1,
    priority: 'P1',
    status: 'open',
    description: 'Uma vulnerabilidade crítica de escrita fora dos limites (out-of-bounds write) foi identificada no FortiOS, o sistema operacional dos firewalls Fortinet FortiGate. Esta falha permite que atacantes não autenticados executem código arbitrário ou causem negação de serviço (DoS) através de requisições HTTP especialmente criadas enviadas para a interface de gerenciamento web.\n\nA vulnerabilidade reside no módulo de processamento SSL VPN e pode ser explorada remotamente sem necessidade de autenticação prévia. Atacantes podem aproveitar esta falha para obter controle total do dispositivo, interceptar tráfego de rede, modificar configurações de segurança ou estabelecer persistência no ambiente.\n\nEsta vulnerabilidade foi adicionada à lista CISA Known Exploited Vulnerabilities (KEV) devido a evidências de exploração ativa em ambientes corporativos.',
    vendor: 'Fortinet',
    product: 'FortiOS',
    affectedVersions: '6.0.0 - 6.0.17, 6.2.0 - 6.2.14, 6.4.0 - 6.4.13, 7.0.0 - 7.0.10',
    portProtocol: '443/HTTPS',
    detectedDate: '2024-08-15',
    publishedDate: '2024-02-09',
    cvss: 9.8,
    cvssVector: 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H',
    cveIds: ['CVE-2024-21762', 'CVE-2024-23113'],
    exploitability: 'Alta',
    publicExploit: true,
    cisaKev: true,
    mitreMapping: [
      { id: 'T1190', name: 'Exploit Public-Facing Application', tactic: 'Initial Access', subtechniques: [] },
      { id: 'T1068', name: 'Exploitation for Privilege Escalation', tactic: 'Privilege Escalation', subtechniques: [] },
    ],
    compliance: ['ACN', 'SOX'],
    assetCriticality: 'Crítica',
    businessImpact: 'Alto - Potencial comprometimento total de perímetro de segurança, exfiltração de dados sensíveis, e disrupção de serviços críticos de conectividade.',
    remediationSteps: [
      'Aplicar patch de segurança FortiOS versão 7.0.11 ou superior imediatamente',
      'Validar integridade do sistema após aplicação do patch',
      'Reiniciar dispositivo FortiGate para garantir aplicação completa',
      'Executar re-scan Qualys para confirmar remediação',
      'Revisar logs de acesso dos últimos 30 dias',
      'Atualizar documentação de change management',
      'Notificar equipe de segurança e compliance',
    ],
    workarounds: [
      'Desabilitar acesso à interface de gerenciamento web via Internet',
      'Implementar regra de firewall upstream bloqueando acesso externo à porta 443/admin',
      'Habilitar autenticação multifator (MFA) para contas administrativas',
      'Ativar logging detalhado e monitoramento via SIEM',
      'Aplicar rate limiting nas interfaces de gerenciamento web',
    ],
    references: [
      { type: 'NVD', title: 'CVE-2024-21762 - National Vulnerability Database', url: 'https://nvd.nist.gov/vuln/detail/CVE-2024-21762' },
      { type: 'Vendor Advisory', title: 'FortiGuard Labs - FG-IR-24-015', url: 'https://fortiguard.com/psirt/FG-IR-24-015' },
      { type: 'CISA', title: 'CISA Known Exploited Vulnerabilities Catalog', url: 'https://www.cisa.gov/known-exploited-vulnerabilities-catalog' },
      { type: 'Exploit-DB', title: 'Fortinet FortiOS SSL VPN - RCE', url: 'https://www.exploit-db.com/exploits/51234' },
    ],
    affectedAssets: [
      { id: 1, hostname: 'fw-prod-01.corp.local', ip: '10.10.1.100', type: 'Firewall', os: 'FortiOS 7.0.8', layer: 1, patchStatus: 'Pendente', lastDetected: '2024-08-15' },
      { id: 2, hostname: 'fw-dr-01.corp.local', ip: '10.10.2.100', type: 'Firewall', os: 'FortiOS 7.0.8', layer: 1, patchStatus: 'Agendado', lastDetected: '2024-08-15' },
      { id: 3, hostname: 'fw-perimeter-01.corp.local', ip: '10.10.1.101', type: 'Firewall', os: 'FortiOS 6.4.12', layer: 1, patchStatus: 'Pendente', lastDetected: '2024-08-15' },
      { id: 4, hostname: 'fw-dmz-01.corp.local', ip: '10.20.1.50', type: 'Firewall', os: 'FortiOS 7.0.9', layer: 1, patchStatus: 'Em progresso', lastDetected: '2024-08-15' },
    ],
    timeline: [
      { type: 'detected', title: 'Vulnerabilidade detectada', description: 'Detectada pelo Qualys Vulnerability Scanner durante scan automático', timestamp: '2024-08-15T14:30:00Z', user: 'Sistema Qualys' },
      { type: 'assigned', title: 'Atribuída para equipe', description: 'Vulnerabilidade atribuída para João Silva (Team Firewall)', timestamp: '2024-08-16T09:15:00Z', user: 'Maria Santos' },
      { type: 'status_change', title: 'Status alterado', description: 'Status alterado de "Aberta" para "Em progresso"', timestamp: '2024-08-20T16:20:00Z', user: 'João Silva' },
      { type: 'note', title: 'Nota adicionada', description: 'Patch agendado para janela de manutenção de 02/09. Workarounds temporários aplicados.', timestamp: '2024-08-25T10:00:00Z', user: 'João Silva' },
      { type: 'patch', title: 'Patch parcialmente aplicado', description: 'Patch aplicado em 2 de 4 ativos. Restantes pendentes de aprovação.', timestamp: '2024-09-02T23:45:00Z', user: 'João Silva' },
    ],
    notes: [
      { content: 'Validado com time de infra que janela de manutenção está aprovada para 15/09.', timestamp: '2024-09-05T11:30:00Z', author: 'João Silva' },
      { content: 'Re-scan executado. Confirmada remediação em fw-prod-01 e fw-dr-01.', timestamp: '2024-09-03T08:15:00Z', author: 'Sistema Qualys' },
    ],
    eol: false,
    agingDays: 185,
    agingBucket: '181-365d',
    asset: 'fw-prod-01.corp.local',
    assetType: 'Firewall',
  },
  731489: {
    qid: 731489,
    title: 'ConnectWise ScreenConnect Authentication Bypass',
    severity: 'cisaCritical',
    layerRisk: 1,
    priority: 'P1',
    status: 'in_progress',
    description: 'Uma vulnerabilidade de bypass de autenticação no ConnectWise ScreenConnect permite que atacantes criem contas de administrador e executem código remoto sem autenticação. A falha é crítica e já está sendo explorada ativamente.\n\nA CISA adicionou esta vulnerabilidade ao catálogo KEV e recomenda remediação imediata.',
    vendor: 'ConnectWise',
    product: 'ScreenConnect',
    affectedVersions: '23.9.7 e anteriores',
    portProtocol: '443/HTTPS',
    detectedDate: '2025-09-15',
    publishedDate: '2024-02-19',
    cvss: 10.0,
    cvssVector: 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H',
    cveIds: ['CVE-2024-1709', 'CVE-2024-1708'],
    exploitability: 'Alta',
    publicExploit: true,
    cisaKev: true,
    mitreMapping: [
      { id: 'T1190', name: 'Exploit Public-Facing Application', tactic: 'Initial Access', subtechniques: [] },
      { id: 'T1078', name: 'Valid Accounts', tactic: 'Persistence', subtechniques: ['T1078.001'] },
    ],
    compliance: ['ACN', 'SOX', 'LGPD'],
    assetCriticality: 'Crítica',
    businessImpact: 'Crítico - Acesso remoto não autorizado a todos os endpoints gerenciados.',
    remediationSteps: [
      'Atualizar ScreenConnect para versão 23.9.8 ou superior imediatamente',
      'Revisar logs de acesso para acessos não autorizados',
      'Resetar todas as credenciais de administrador',
      'Verificar se novas contas foram criadas indevidamente',
      'Executar re-scan para confirmar remediação',
    ],
    workarounds: [
      'Restringir acesso à interface de administração por IP',
      'Desabilitar criação de novas contas de administrador',
      'Ativar MFA em todas as contas existentes',
    ],
    references: [
      { type: 'NVD', title: 'CVE-2024-1709 - NVD', url: 'https://nvd.nist.gov/vuln/detail/CVE-2024-1709' },
      { type: 'CISA', title: 'CISA KEV Catalog', url: 'https://www.cisa.gov/known-exploited-vulnerabilities-catalog' },
    ],
    affectedAssets: [
      { id: 1, hostname: 'rmm-server.corp.local', ip: '10.10.5.50', type: 'Server', os: 'Windows Server 2022', layer: 1, patchStatus: 'Em progresso', lastDetected: '2025-09-15' },
      { id: 2, hostname: 'rmm-backup.corp.local', ip: '10.10.5.51', type: 'Server', os: 'Windows Server 2022', layer: 1, patchStatus: 'Pendente', lastDetected: '2025-09-15' },
    ],
    timeline: [
      { type: 'detected', title: 'Vulnerabilidade detectada', description: 'Detectada pelo Qualys durante scan semanal', timestamp: '2025-09-15T10:00:00Z', user: 'Sistema Qualys' },
      { type: 'assigned', title: 'Atribuída', description: 'Atribuída para equipe de RMM', timestamp: '2025-09-15T14:00:00Z', user: 'Carlos Mendes' },
      { type: 'status_change', title: 'Status alterado', description: 'Movida para Em progresso', timestamp: '2025-09-16T08:30:00Z', user: 'Ana Costa' },
    ],
    notes: [
      { content: 'Fornecedor confirmou disponibilidade do patch. Agendado para aplicação neste fim de semana.', timestamp: '2025-09-17T09:00:00Z', author: 'Ana Costa' },
    ],
    eol: false,
    agingDays: 148,
    agingBucket: '91-180d',
    asset: 'rmm-server.corp.local',
    assetType: 'Server',
  },
  380234: {
    qid: 380234,
    title: 'GoAnywhere MFT Authentication Bypass',
    severity: 'critical',
    layerRisk: 2,
    priority: 'P2',
    status: 'remediated',
    description: 'Bypass de autenticação no Fortra GoAnywhere MFT permite que um usuário não autorizado crie conta de administrador via portal de administração.',
    vendor: 'Fortra',
    product: 'GoAnywhere MFT',
    affectedVersions: '7.4.0 e anteriores',
    portProtocol: '8000/HTTPS',
    detectedDate: '2025-06-22',
    publishedDate: '2024-01-22',
    cvss: 9.8,
    cvssVector: 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H',
    cveIds: ['CVE-2024-0204'],
    exploitability: 'Alta',
    publicExploit: true,
    cisaKev: false,
    mitreMapping: [
      { id: 'T1190', name: 'Exploit Public-Facing Application', tactic: 'Initial Access', subtechniques: [] },
    ],
    compliance: [],
    assetCriticality: 'Alta',
    businessImpact: 'Alto - Possível acesso não autorizado a arquivos de transferência.',
    remediationSteps: [
      'Upgrade para GoAnywhere MFT 7.4.1 ou superior',
      'Revisar contas de administrador para usuários não autorizados',
    ],
    workarounds: [
      'Restringir acesso ao portal de administração',
      'Monitorar criação de novas contas',
    ],
    references: [
      { type: 'NVD', title: 'CVE-2024-0204', url: 'https://nvd.nist.gov/vuln/detail/CVE-2024-0204' },
    ],
    affectedAssets: [
      { id: 1, hostname: 'file-transfer.corp.local', ip: '10.20.3.10', type: 'Server', os: 'Windows Server 2019', layer: 2, patchStatus: 'Aplicado', lastDetected: '2025-06-22' },
    ],
    timeline: [
      { type: 'detected', title: 'Vulnerabilidade detectada', description: 'Detectada pelo Qualys', timestamp: '2025-06-22T12:00:00Z', user: 'Sistema Qualys' },
      { type: 'patch', title: 'Patch aplicado', description: 'Upgrade realizado com sucesso', timestamp: '2025-07-10T22:00:00Z', user: 'Pedro Lima' },
    ],
    notes: [],
    eol: false,
    agingDays: 233,
    agingBucket: '181-365d',
    asset: 'file-transfer.corp.local',
    assetType: 'Server',
  },
};

// Helper to get detail by QID, falling back to generating a basic one from the vulnerability list item
export function getVulnerabilityDetail(qid: number): VulnerabilityDetail | null {
  return vulnerabilityDetails[qid] || null;
}
