import { Eye, Server } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Checkbox } from '@/components/ui/checkbox';
import {
  Table, TableBody, TableCell, TableHead, TableHeader, TableRow,
} from '@/components/ui/table';
import { AssetVulnerability } from '@/lib/assetData';
import { cn } from '@/lib/utils';

interface AssetVulnerabilityTableProps {
  data: AssetVulnerability[];
  selectedIds: string[];
  onToggleSelect: (id: string) => void;
  onToggleSelectAll: () => void;
  onViewDetail: (qid: number) => void;
}

const severityStyles: Record<string, string> = {
  critical: 'bg-[#DC2626]/10 text-[#DC2626] border border-[#DC2626]/20',
  cisaCritical: 'bg-[#991B1B]/15 text-[#991B1B] border border-[#991B1B]/25',
  high: 'bg-[#EA580C]/10 text-[#EA580C] border border-[#EA580C]/20',
  medium: 'bg-[#D97706]/10 text-[#D97706] border border-[#D97706]/20',
  low: 'bg-[#2563EB]/10 text-[#2563EB] border border-[#2563EB]/20',
};

const severityLabels: Record<string, string> = {
  critical: 'Critical',
  cisaCritical: 'CISA Critical',
  high: 'High',
  medium: 'Medium',
  low: 'Low',
};

const statusLabels: Record<string, string> = {
  open: 'Aberta',
  in_progress: 'Em progresso',
  remediated: 'Remediada',
  accepted: 'Aceita',
};

const statusStyles: Record<string, string> = {
  open: 'bg-severity-critical/20 text-severity-critical',
  in_progress: 'bg-severity-high/20 text-severity-high',
  remediated: 'bg-status-success/20 text-status-success',
  accepted: 'bg-muted text-muted-foreground',
};

export function AssetVulnerabilityTable({ data, selectedIds, onToggleSelect, onToggleSelectAll, onViewDetail }: AssetVulnerabilityTableProps) {
  // Track QID groups for alternating backgrounds
  let lastQid = -1;
  let qidGroupIndex = 0;

  return (
    <div className="glass-card overflow-hidden">
      <Table>
        <TableHeader>
          <TableRow className="border-border hover:bg-transparent">
            <TableHead className="w-12">
              <Checkbox
                checked={selectedIds.length === data.length && data.length > 0}
                onCheckedChange={onToggleSelectAll}
              />
            </TableHead>
            <TableHead>QID</TableHead>
            <TableHead>Título</TableHead>
            <TableHead>Severidade</TableHead>
            <TableHead>Layer</TableHead>
            <TableHead>Prioridade</TableHead>
            <TableHead>Hostname</TableHead>
            <TableHead>IP</TableHead>
            <TableHead>Empresa</TableHead>
            <TableHead>SO/Versão</TableHead>
            <TableHead>EoL</TableHead>
            <TableHead>Status</TableHead>
            <TableHead>Aging</TableHead>
            <TableHead className="text-right">Ações</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {data.map((av) => {
            if (av.qid !== lastQid) {
              qidGroupIndex++;
              lastQid = av.qid;
            }
            const isEvenGroup = qidGroupIndex % 2 === 0;

            return (
              <TableRow
                key={av.vulnId}
                className={cn(
                  'border-border cursor-pointer hover:bg-accent/50 transition-all duration-150',
                  isEvenGroup && 'bg-muted/20',
                  selectedIds.includes(av.vulnId) && 'bg-primary/5',
                )}
                onClick={() => onViewDetail(av.qid)}
              >
                <TableCell onClick={(e) => e.stopPropagation()}>
                  <Checkbox checked={selectedIds.includes(av.vulnId)} onCheckedChange={() => onToggleSelect(av.vulnId)} />
                </TableCell>
                <TableCell>
                  <code className="text-xs font-mono text-primary">{av.qid}</code>
                </TableCell>
                <TableCell>
                  <span className="text-sm font-medium line-clamp-1 max-w-[180px]">{av.title}</span>
                </TableCell>
                <TableCell>
                  <Badge className={severityStyles[av.severity]}>{severityLabels[av.severity]}</Badge>
                </TableCell>
                <TableCell>
                  <span className={cn(
                    'inline-flex items-center justify-center w-7 h-7 rounded text-xs font-bold',
                    av.layerRisk === 1 ? 'bg-severity-critical/20 text-severity-critical' :
                    av.layerRisk === 2 ? 'bg-severity-high/20 text-severity-high' :
                    av.layerRisk === 3 ? 'bg-severity-medium/20 text-severity-medium' :
                    'bg-severity-low/20 text-severity-low'
                  )}>
                    L{av.layerRisk}
                  </span>
                </TableCell>
                <TableCell>
                  <span className={cn('px-2 py-1 rounded text-xs font-bold',
                    av.priority === 'P1' ? 'text-severity-critical bg-severity-critical/10' :
                    av.priority === 'P2' ? 'text-severity-high bg-severity-high/10' :
                    av.priority === 'P3' ? 'text-severity-medium bg-severity-medium/10' :
                    'text-severity-low bg-severity-low/10'
                  )}>
                    {av.priority}
                  </span>
                </TableCell>
                <TableCell>
                  <div className="flex items-center gap-1.5">
                    <Server className="w-3 h-3 text-muted-foreground shrink-0" />
                    <span className="text-sm font-mono line-clamp-1 max-w-[150px]">{av.hostname}</span>
                  </div>
                </TableCell>
                <TableCell>
                  <span className="text-xs font-mono text-muted-foreground">{av.ip}</span>
                </TableCell>
                <TableCell>
                  <Badge variant="secondary" className="text-[10px]">{av.empresa}</Badge>
                </TableCell>
                <TableCell>
                  <span className="text-xs text-muted-foreground">{av.os}</span>
                </TableCell>
                <TableCell>
                  {av.assetEol ? (
                    <Badge className="bg-severity-critical/20 text-severity-critical text-xs">EoL</Badge>
                  ) : (
                    <Badge className="bg-status-success/20 text-status-success text-xs">Non-EoL</Badge>
                  )}
                </TableCell>
                <TableCell>
                  <Badge className={statusStyles[av.status]}>{statusLabels[av.status]}</Badge>
                </TableCell>
                <TableCell>
                  <span className="text-xs font-mono text-muted-foreground">{av.agingBucket}</span>
                </TableCell>
                <TableCell className="text-right" onClick={(e) => e.stopPropagation()}>
                  <Button variant="ghost" size="icon" onClick={() => onViewDetail(av.qid)}>
                    <Eye className="w-4 h-4" />
                  </Button>
                </TableCell>
              </TableRow>
            );
          })}
        </TableBody>
      </Table>
    </div>
  );
}
