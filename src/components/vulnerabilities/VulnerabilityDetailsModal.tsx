import { useState } from 'react';
import {
  ExternalLink, UserPlus, Edit, FileText, X, Shield, AlertTriangle,
  Target, Building, Wrench, Link2, Clock, History, MessageSquare,
  Plus, Server, Download, Scan, RefreshCw, CheckCircle, Circle, AlertCircle,
} from 'lucide-react';
import { Dialog, DialogContent } from '@/components/ui/dialog';
import { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator';
import { Textarea } from '@/components/ui/textarea';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import {
  Table, TableBody, TableCell, TableHead, TableHeader, TableRow,
} from '@/components/ui/table';
import {
  DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { cn } from '@/lib/utils';
import { VulnerabilityDetail, VulnTimelineEvent } from '@/lib/vulnerabilityDetailsData';
import { Severity, LayerRisk, Priority } from '@/lib/mockData';

const severityLabels: Record<Severity, string> = {
  critical: 'Critical',
  cisaCritical: 'CISA Critical',
  high: 'High',
  medium: 'Medium',
  low: 'Low',
};

const severityStyles: Record<Severity, string> = {
  critical: 'severity-badge-critical',
  cisaCritical: 'bg-[hsl(0_50%_35%/0.2)] text-[hsl(0_50%_50%)] border border-[hsl(0_50%_35%/0.3)]',
  high: 'severity-badge-high',
  medium: 'severity-badge-medium',
  low: 'severity-badge-low',
};

const priorityColors: Record<Priority, string> = {
  P1: 'text-severity-critical bg-severity-critical/10',
  P2: 'text-severity-high bg-severity-high/10',
  P3: 'text-severity-medium bg-severity-medium/10',
  P4: 'text-severity-low bg-severity-low/10',
};

const statusLabels: Record<string, string> = {
  open: 'Aberta',
  in_progress: 'Em progresso',
  remediated: 'Remediada',
  accepted: 'Aceita',
};

const statusStyles: Record<string, string> = {
  open: 'bg-severity-critical/20 text-severity-critical',
  in_progress: 'bg-severity-high/20 text-severity-high',
  remediated: 'bg-status-success/20 text-status-success',
  accepted: 'bg-muted text-muted-foreground',
};

const layerColors: Record<number, string> = {
  1: 'bg-severity-critical/20 text-severity-critical',
  2: 'bg-severity-high/20 text-severity-high',
  3: 'bg-severity-medium/20 text-severity-medium',
  4: 'bg-severity-low/20 text-severity-low',
};

const patchStatusStyles: Record<string, string> = {
  'Pendente': 'bg-severity-critical/20 text-severity-critical',
  'Agendado': 'bg-severity-medium/20 text-severity-medium',
  'Em progresso': 'bg-severity-high/20 text-severity-high',
  'Aplicado': 'bg-status-success/20 text-status-success',
};

const layerDescriptions: Record<number, string> = {
  1: 'Ativos expostos à Internet com compliance ACN/SOX/LGPD',
  2: 'Ativos expostos à Internet sem compliance',
  3: 'Rede interna com compliance ACN/SOX/LGPD',
  4: 'Rede interna sem compliance',
};

function formatDate(dateStr: string) {
  return new Date(dateStr).toLocaleDateString('pt-BR');
}

function formatDateTime(dateStr: string) {
  return new Date(dateStr).toLocaleString('pt-BR', {
    day: '2-digit', month: '2-digit', year: 'numeric',
    hour: '2-digit', minute: '2-digit',
  });
}

function getTimelineIcon(type: VulnTimelineEvent['type']) {
  const icons = {
    detected: <Scan className="w-4 h-4 text-primary" />,
    assigned: <UserPlus className="w-4 h-4 text-severity-low" />,
    status_change: <RefreshCw className="w-4 h-4 text-severity-medium" />,
    note: <MessageSquare className="w-4 h-4 text-status-success" />,
    patch: <CheckCircle className="w-4 h-4 text-status-success" />,
  };
  return icons[type] || <Circle className="w-4 h-4" />;
}

function getTimelineDotColor(type: VulnTimelineEvent['type']) {
  const colors = {
    detected: 'bg-primary',
    assigned: 'bg-severity-low',
    status_change: 'bg-severity-medium',
    note: 'bg-status-success',
    patch: 'bg-status-success',
  };
  return colors[type] || 'bg-muted-foreground';
}

interface InfoRowProps {
  label: string;
  value: string | number;
  mono?: boolean;
}

function InfoRow({ label, value, mono }: InfoRowProps) {
  return (
    <div className="flex justify-between items-center text-sm">
      <span className="text-muted-foreground">{label}:</span>
      <span className={cn('font-medium', mono && 'font-mono')}>{value}</span>
    </div>
  );
}

interface Props {
  vuln: VulnerabilityDetail | null;
  open: boolean;
  onClose: () => void;
}

export default function VulnerabilityDetailsModal({ vuln, open, onClose }: Props) {
  const [newNote, setNewNote] = useState('');

  if (!vuln) return null;

  const urgencyLabel =
    vuln.priority === 'P1' ? 'URGENTE - 48 HORAS' :
    vuln.priority === 'P2' ? 'ALTA - 7 DIAS' :
    vuln.priority === 'P3' ? 'MÉDIA - 30 DIAS' : 'BAIXA - 90 DIAS';

  return (
    <Dialog open={open} onOpenChange={() => onClose()}>
      <DialogContent className="max-w-[1400px] w-[95vw] max-h-[95vh] p-0 gap-0 overflow-hidden">
        {/* HEADER */}
        <div className="p-6 border-b border-border bg-card">
          <div className="flex items-start justify-between mb-3">
            <div className="flex-1">
              <div className="flex items-center gap-3 mb-2">
                <span className="font-mono text-2xl text-primary font-bold">
                  QID {vuln.qid}
                </span>
              </div>
              <h2 className="text-lg font-semibold text-foreground">{vuln.title}</h2>
            </div>
            <Button variant="ghost" size="icon" onClick={onClose} className="shrink-0">
              <X className="w-5 h-5" />
            </Button>
          </div>

          <div className="flex items-center gap-2 mb-4 flex-wrap">
            <Badge className={severityStyles[vuln.severity]}>{severityLabels[vuln.severity]}</Badge>
            <Badge className={layerColors[vuln.layerRisk]}>L{vuln.layerRisk}</Badge>
            <span className={cn('px-2 py-1 rounded text-xs font-bold', priorityColors[vuln.priority])}>{vuln.priority}</span>
            <Badge className={statusStyles[vuln.status]}>{statusLabels[vuln.status]}</Badge>
          </div>

          <div className="flex items-center gap-2 flex-wrap">
            <Button variant="outline" size="sm">
              <UserPlus className="w-4 h-4 mr-2" />
              Atribuir
            </Button>
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="outline" size="sm">
                  <Edit className="w-4 h-4 mr-2" />
                  Alterar Status
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent className="bg-popover border-border">
                <DropdownMenuItem>Aberta</DropdownMenuItem>
                <DropdownMenuItem>Em progresso</DropdownMenuItem>
                <DropdownMenuItem>Remediada</DropdownMenuItem>
                <DropdownMenuItem>Aceita</DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
            <Button variant="outline" size="sm">
              <FileText className="w-4 h-4 mr-2" />
              Exportar PDF
            </Button>
          </div>
        </div>

        {/* TABS + CONTENT */}
        <Tabs defaultValue="overview" className="flex flex-col flex-1 min-h-0">
          <TabsList className="grid w-full grid-cols-5 rounded-none border-b border-border bg-card/50 h-auto p-1">
            <TabsTrigger value="overview" className="text-xs sm:text-sm">Visão Geral</TabsTrigger>
            <TabsTrigger value="assets" className="text-xs sm:text-sm">Ativos Afetados</TabsTrigger>
            <TabsTrigger value="risk" className="text-xs sm:text-sm">Análise de Risco</TabsTrigger>
            <TabsTrigger value="remediation" className="text-xs sm:text-sm">Remediação</TabsTrigger>
            <TabsTrigger value="timeline" className="text-xs sm:text-sm">Timeline & Notas</TabsTrigger>
          </TabsList>

          <ScrollArea className="flex-1 max-h-[calc(95vh-260px)]">
            {/* TAB 1: VISÃO GERAL */}
            <TabsContent value="overview" className="p-6 space-y-6 mt-0">
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="lg:col-span-2 space-y-4">
                  <h3 className="text-lg font-semibold">Descrição</h3>
                  <div className="text-sm text-muted-foreground space-y-3 whitespace-pre-line">
                    {vuln.description}
                  </div>
                </div>
                <div className="space-y-4">
                  <h3 className="text-lg font-semibold">Informações Técnicas</h3>
                  <div className="glass-card p-4 space-y-3">
                    <InfoRow label="QID" value={vuln.qid} mono />
                    <InfoRow label="Severidade" value={severityLabels[vuln.severity]} />
                    <InfoRow label="Layer Risk" value={`L${vuln.layerRisk}`} />
                    <InfoRow label="Prioridade" value={vuln.priority} />
                    <InfoRow label="Vendor" value={vuln.vendor} />
                    <InfoRow label="Produto" value={vuln.product} />
                    <InfoRow label="Versões afetadas" value={vuln.affectedVersions} />
                    <InfoRow label="Porta/Protocolo" value={vuln.portProtocol} />
                    <InfoRow label="Detectada em" value={formatDate(vuln.detectedDate)} />
                    <InfoRow label="Publicada em" value={formatDate(vuln.publishedDate)} />
                    <InfoRow label="Aging" value={`${vuln.agingDays}d (${vuln.agingBucket})`} />
                    {vuln.cveIds.length > 0 && (
                      <>
                        <Separator />
                        <div>
                          <span className="text-sm text-muted-foreground">CVE IDs:</span>
                          <div className="flex flex-wrap gap-1 mt-1">
                            {vuln.cveIds.map(cve => (
                              <Badge key={cve} variant="outline" className="font-mono text-xs">{cve}</Badge>
                            ))}
                          </div>
                        </div>
                      </>
                    )}
                  </div>
                </div>
              </div>
            </TabsContent>

            {/* TAB 2: ATIVOS AFETADOS */}
            <TabsContent value="assets" className="p-6 space-y-4 mt-0">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <Server className="w-5 h-5 text-primary" />
                  <span className="text-lg font-semibold">
                    {vuln.affectedAssets.length} ativos afetados
                  </span>
                </div>
                <Button variant="outline" size="sm">
                  <Download className="w-4 h-4 mr-2" />
                  Exportar CSV
                </Button>
              </div>
              <div className="glass-card overflow-hidden">
                <Table>
                  <TableHeader>
                    <TableRow className="border-border">
                      <TableHead>Hostname</TableHead>
                      <TableHead>IP</TableHead>
                      <TableHead>Tipo</TableHead>
                      <TableHead>SO / Versão</TableHead>
                      <TableHead>Layer</TableHead>
                      <TableHead>Status Patch</TableHead>
                      <TableHead>Última Detecção</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {vuln.affectedAssets.map((asset) => (
                      <TableRow key={asset.id} className="border-border">
                        <TableCell className="font-mono text-sm">{asset.hostname}</TableCell>
                        <TableCell className="font-mono text-xs text-muted-foreground">{asset.ip}</TableCell>
                        <TableCell className="text-sm">{asset.type}</TableCell>
                        <TableCell className="text-sm">{asset.os}</TableCell>
                        <TableCell>
                          <Badge className={layerColors[asset.layer]}>L{asset.layer}</Badge>
                        </TableCell>
                        <TableCell>
                          <Badge className={patchStatusStyles[asset.patchStatus] || 'bg-muted text-muted-foreground'}>
                            {asset.patchStatus}
                          </Badge>
                        </TableCell>
                        <TableCell className="text-sm text-muted-foreground">{formatDate(asset.lastDetected)}</TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </div>
            </TabsContent>

            {/* TAB 3: ANÁLISE DE RISCO */}
            <TabsContent value="risk" className="p-6 space-y-6 mt-0">
              {/* CVSS */}
              <div className="glass-card p-6">
                <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                  <Shield className="w-5 h-5 text-primary" />
                  CVSS Score Breakdown
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <div className="text-center mb-4">
                      <div className="text-5xl font-bold text-destructive">{vuln.cvss}</div>
                      <div className="text-sm text-muted-foreground mt-1">CVSS v3.1 Score</div>
                    </div>
                    <div className="text-xs font-mono text-muted-foreground break-all text-center">
                      {vuln.cvssVector}
                    </div>
                  </div>
                  <div className="space-y-2">
                    {[
                      ['Attack Vector', 'Network'],
                      ['Attack Complexity', 'Low'],
                      ['Privileges Required', 'None'],
                      ['User Interaction', 'None'],
                      ['Scope', 'Unchanged'],
                      ['Confidentiality', 'High'],
                      ['Integrity', 'High'],
                      ['Availability', 'High'],
                    ].map(([label, value]) => (
                      <div key={label} className="flex items-center justify-between text-sm">
                        <span className="text-muted-foreground">{label}:</span>
                        <Badge variant="destructive" className="text-xs">{value}</Badge>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              {/* Exploitabilidade */}
              <div className="glass-card p-6">
                <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                  <AlertTriangle className="w-5 h-5 text-destructive" />
                  Exploitabilidade & Ameaças
                </h3>
                <div className="grid grid-cols-3 gap-4">
                  {[
                    ['Exploitabilidade', vuln.exploitability],
                    ['Exploit Público', vuln.publicExploit ? 'SIM' : 'NÃO'],
                    ['CISA KEV', vuln.cisaKev ? 'LISTADA' : 'NÃO'],
                  ].map(([label, value]) => (
                    <div key={String(label)} className="text-center p-4 border border-border rounded-lg">
                      <div className="text-sm text-muted-foreground mb-2">{label}</div>
                      <Badge className={cn(
                        'text-lg px-4 py-1',
                        (value === 'Alta' || value === 'SIM' || value === 'LISTADA')
                          ? 'bg-destructive/20 text-destructive border-destructive/30'
                          : 'bg-muted text-muted-foreground',
                      )}>
                        {String(value)}
                      </Badge>
                    </div>
                  ))}
                </div>
                {vuln.cisaKev && (
                  <Alert className="mt-4 border-destructive/50 bg-destructive/10">
                    <AlertCircle className="h-4 w-4" />
                    <AlertTitle>Atenção: Exploração Ativa</AlertTitle>
                    <AlertDescription>
                      Esta vulnerabilidade consta na lista CISA Known Exploited Vulnerabilities e possui exploits públicos disponíveis. Priorize a remediação imediata.
                    </AlertDescription>
                  </Alert>
                )}
              </div>

              {/* MITRE ATT&CK */}
              <div className="glass-card p-6">
                <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                  <Target className="w-5 h-5 text-primary" />
                  MITRE ATT&CK Mapping
                </h3>
                <div className="space-y-3">
                  {vuln.mitreMapping.map((technique) => (
                    <div key={technique.id} className="border border-border rounded-lg p-4 hover:border-primary/50 transition-colors">
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-1">
                            <Badge variant="outline" className="font-mono">{technique.id}</Badge>
                            <span className="font-semibold">{technique.name}</span>
                          </div>
                          <div className="text-sm text-muted-foreground">
                            Tática: <span className="text-foreground">{technique.tactic}</span>
                          </div>
                          {technique.subtechniques.length > 0 && (
                            <div className="text-xs text-muted-foreground mt-2">
                              Sub-técnicas: {technique.subtechniques.join(', ')}
                            </div>
                          )}
                        </div>
                        <Button variant="ghost" size="sm" asChild>
                          <a href={`https://attack.mitre.org/techniques/${technique.id.replace('.', '/')}/`} target="_blank" rel="noopener noreferrer">
                            <ExternalLink className="w-4 h-4" />
                          </a>
                        </Button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Contexto de Negócio */}
              <div className="glass-card p-6">
                <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                  <Building className="w-5 h-5 text-primary" />
                  Contexto de Negócio (Layer Risk)
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <div className="text-sm text-muted-foreground mb-2">Layer Risk</div>
                    <Badge className={cn('text-xl px-4 py-2', layerColors[vuln.layerRisk])}>
                      Layer Risk {vuln.layerRisk}
                    </Badge>
                    <p className="text-sm text-muted-foreground mt-3">
                      {layerDescriptions[vuln.layerRisk]}
                    </p>
                  </div>
                  <div className="space-y-4">
                    <div>
                      <div className="text-sm text-muted-foreground mb-2">Compliance Aplicável</div>
                      <div className="flex flex-wrap gap-2">
                        {vuln.compliance.length > 0
                          ? vuln.compliance.map((comp) => (
                              <Badge key={comp} variant="outline" className="text-sm">{comp}</Badge>
                            ))
                          : <span className="text-sm text-muted-foreground">Sem tags de compliance</span>
                        }
                      </div>
                    </div>
                    <div>
                      <div className="text-sm text-muted-foreground mb-2">Criticidade do Ativo</div>
                      <Badge variant="outline" className="text-sm">{vuln.assetCriticality}</Badge>
                    </div>
                    <div>
                      <div className="text-sm text-muted-foreground mb-2">Impacto Estimado</div>
                      <p className="text-sm">{vuln.businessImpact}</p>
                    </div>
                  </div>
                </div>
              </div>
            </TabsContent>

            {/* TAB 4: REMEDIAÇÃO */}
            <TabsContent value="remediation" className="p-6 space-y-6 mt-0">
              <div className="glass-card p-6">
                <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                  <Wrench className="w-5 h-5 text-primary" />
                  Steps de Remediação
                </h3>
                <ol className="space-y-4">
                  {vuln.remediationSteps.map((step, index) => (
                    <li key={index} className="flex gap-3">
                      <div className="flex-shrink-0 w-8 h-8 rounded-full bg-primary/20 text-primary flex items-center justify-center font-bold text-sm">
                        {index + 1}
                      </div>
                      <div className="flex-1 pt-1.5">
                        <p className="text-sm">{step}</p>
                      </div>
                    </li>
                  ))}
                </ol>
              </div>

              {vuln.workarounds.length > 0 && (
                <div className="glass-card p-6">
                  <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                    <Shield className="w-5 h-5 text-severity-medium" />
                    Workarounds Temporários
                  </h3>
                  <Alert className="mb-3 border-severity-medium/50 bg-severity-medium/10">
                    <AlertCircle className="h-4 w-4" />
                    <AlertDescription>
                      Aplicar estas mitigações temporárias caso o patch não possa ser aplicado imediatamente.
                    </AlertDescription>
                  </Alert>
                  <ul className="space-y-2">
                    {vuln.workarounds.map((workaround, index) => (
                      <li key={index} className="flex gap-2 text-sm">
                        <span className="text-severity-medium">•</span>
                        <span>{workaround}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              )}

              <div className="glass-card p-6">
                <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                  <Link2 className="w-5 h-5 text-primary" />
                  Referências e Links
                </h3>
                <div className="space-y-2">
                  {vuln.references.map((ref, index) => (
                    <a key={index} href={ref.url} target="_blank" rel="noopener noreferrer"
                      className="flex items-center gap-2 text-sm text-primary hover:underline">
                      <ExternalLink className="w-4 h-4 shrink-0" />
                      <span>[{ref.type}] {ref.title}</span>
                    </a>
                  ))}
                </div>
              </div>

              <div className="glass-card p-6 border-2 border-destructive/30">
                <h3 className="text-lg font-semibold mb-3 flex items-center gap-2 text-destructive">
                  <Clock className="w-5 h-5" />
                  Prioridade de Remediação Recomendada
                </h3>
                <Badge className={cn(
                  'text-xl px-6 py-3',
                  vuln.priority === 'P1' ? 'bg-destructive text-destructive-foreground animate-pulse'
                    : vuln.priority === 'P2' ? 'bg-severity-high text-destructive-foreground'
                    : 'bg-severity-medium text-destructive-foreground',
                )}>
                  {urgencyLabel}
                </Badge>
                <p className="text-sm text-muted-foreground mt-3">
                  Baseado na severidade ({severityLabels[vuln.severity]}), exploitabilidade ({vuln.exploitability}), Layer Risk (L{vuln.layerRisk}){vuln.cisaKev ? ', e presença na lista CISA KEV' : ''}.
                </p>
              </div>
            </TabsContent>

            {/* TAB 5: TIMELINE & NOTAS */}
            <TabsContent value="timeline" className="p-6 space-y-6 mt-0">
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="lg:col-span-2">
                  <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                    <History className="w-5 h-5 text-primary" />
                    Timeline de Atividades
                  </h3>
                  <div className="space-y-0">
                    {vuln.timeline.map((event, index) => (
                      <div key={index} className="flex gap-4">
                        <div className="flex flex-col items-center">
                          <div className={cn('w-3 h-3 rounded-full shrink-0', getTimelineDotColor(event.type))} />
                          {index < vuln.timeline.length - 1 && (
                            <div className="w-0.5 flex-1 bg-border" />
                          )}
                        </div>
                        <div className="flex-1 pb-6">
                          <div className="flex items-center gap-2 mb-1">
                            {getTimelineIcon(event.type)}
                            <span className="text-sm font-semibold">{event.title}</span>
                          </div>
                          <p className="text-sm text-muted-foreground mb-1">{event.description}</p>
                          <div className="flex items-center gap-3 text-xs text-muted-foreground">
                            <span>{formatDateTime(event.timestamp)}</span>
                            {event.user && (
                              <>
                                <span>•</span>
                                <span>por {event.user}</span>
                              </>
                            )}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                <div>
                  <h3 className="text-lg font-semibold mb-4">Adicionar Nota</h3>
                  <div className="glass-card p-4 space-y-3">
                    <Textarea
                      placeholder="Digite sua nota sobre esta vulnerabilidade..."
                      className="min-h-[120px] resize-none"
                      value={newNote}
                      onChange={(e) => setNewNote(e.target.value)}
                    />
                    <Button className="w-full" disabled={!newNote.trim()}>
                      <Plus className="w-4 h-4 mr-2" />
                      Salvar Nota
                    </Button>
                  </div>

                  {vuln.notes.length > 0 && (
                    <div className="mt-6 space-y-3">
                      <h4 className="text-sm font-semibold text-muted-foreground">Notas Anteriores</h4>
                      {vuln.notes.map((note, index) => (
                        <div key={index} className="glass-card p-3 text-sm">
                          <p className="text-foreground mb-2">{note.content}</p>
                          <div className="text-xs text-muted-foreground">
                            {formatDateTime(note.timestamp)} • {note.author}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </TabsContent>
          </ScrollArea>
        </Tabs>
      </DialogContent>
    </Dialog>
  );
}
